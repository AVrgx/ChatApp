<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ß–∞—Ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen font-sans">
<div id="authSection" class="w-full max-w-md p-6 bg-white rounded-lg shadow-md mt-4">
  <div class="flex justify-between mb-4">
    <button onclick="showLogin()" class="text-blue-500 font-bold">–í—Ö–æ–¥</button>
    <button onclick="showRegister()" class="text-blue-500 font-bold">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  </div>
  <div id="loginFormSection">
    <h2 class="text-2xl font-bold mb-4 text-center">–í—Ö–æ–¥</h2>
    <form id="loginForm" class="space-y-4">
      <input id="loginUsername" type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full p-2 border rounded" required>
      <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-2 border rounded" required>
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">–í–æ–π—Ç–∏</button>
    </form>
    <p class="mt-2 text-center text-red-500 hidden" id="loginError">–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞</p>
  </div>
  <div id="registerFormSection" class="hidden">
    <h2 class="text-2xl font-bold mb-4 text-center">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
    <form id="registerForm" class="space-y-4">
      <input id="registerUsername" type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-full p-2 border rounded" required>
      <input id="registerPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full p-2 border rounded" required>
      <select id="registerRole" class="w-full p-2 border rounded" required>
        <option value="USER">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
        <option value="ADMIN">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
      </select>
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    </form>
    <p class="mt-2 text-center text-red-500 hidden" id="registerError">–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
  </div>
</div>

<div id="chatSection" class="w-full max-w-4xl mt-6 hidden">
  <div class="flex space-x-4">
    <div class="w-1/3 bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-bold mb-4">–ö–æ–º–Ω–∞—Ç—ã</h2>
      <div id="roomList" class="space-y-2 mb-4"></div>
      <input id="roomName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" class="w-full p-2 border rounded mb-2">
      <button onclick="createRoom()" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
      <h2 class="text-xl font-bold mt-6 mb-4">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
      <div id="userList" class="space-y-2"></div>
    </div>
    <div class="w-2/3 bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-bold mb-4">–ß–∞—Ç: <span id="currentRoom">Public</span></h2>
      <div id="chatMessages" class="h-96 overflow-y-auto border p-2 mb-4"></div>
      <form id="messageForm" class="flex space-x-2">
        <input id="messageInput" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" class="w-full p-2 border rounded" required>
        <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  let accessToken = null;
  let username = null;
  let currentRoom = 'Public';

  // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
  function showLogin() {
    document.getElementById('loginFormSection').classList.remove('hidden');
    document.getElementById('registerFormSection').classList.add('hidden');
  }

  // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  function showRegister() {
    document.getElementById('registerFormSection').classList.remove('hidden');
    document.getElementById('loginFormSection').classList.add('hidden');
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  document.getElementById('registerForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const usernameInput = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const role = document.getElementById('registerRole').value;
    fetch('http://localhost:8080/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: usernameInput, password: password, role: role })
    })
            .then(response => {
              if (!response.ok) throw new Error('Registration failed');
              return response.text();
            })
            .then(data => {
              alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ.');
              showLogin();
              document.getElementById('registerUsername').value = '';
              document.getElementById('registerPassword').value = '';
              document.getElementById('registerRole').value = 'USER';
            })
            .catch(error => {
              document.getElementById('registerError').classList.remove('hidden');
              console.error('Registration error:', error);
            });
  });

  // –í—Ö–æ–¥
  document.getElementById('loginForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const usernameInput = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    login(usernameInput, password);
  });

  // –í—Ö–æ–¥
  function login(usernameInput, password) {
    fetch('http://localhost:8080/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: usernameInput, password: password })
    })
            .then(response => {
              if (!response.ok) throw new Error('Login failed');
              return response.json();
            })
            .then(data => {
              accessToken = data.accessToken;
              username = data.username;
              localStorage.setItem('accessToken', accessToken);
              document.getElementById('authSection').classList.add('hidden');
              document.getElementById('chatSection').classList.remove('hidden');

              loadRooms();

              connectWebSocket(() => {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω, –∑–∞—Ö–æ–¥–∏–º –≤ Public');
                // –ó–¥–µ—Å—å –∏–∑–º–µ–Ω—è–µ–º –ª–æ–≥–∏–∫—É - —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è, –ø–æ—Ç–æ–º –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                joinRoom('Public', true); // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞
              });
            })
            .catch(error => {
              document.getElementById('loginError').classList.remove('hidden');
              document.getElementById('loginError').textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message;
            });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–Ω–∞—Ç
  function loadRooms() {
    fetch('http://localhost:8080/api/rooms', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      }
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to load rooms');
              return response.json();
            })
            .then(rooms => {
              const roomList = document.getElementById('roomList');
              roomList.innerHTML = rooms.map(room => `
                    <div class="p-2 bg-gray-200 rounded cursor-pointer hover:bg-gray-300"
                         onclick="joinRoom('${room.name}')">${room.name}</div>
                `).join('');
              console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫–æ–º–Ω–∞—Ç—ã:', rooms);
            })
            .catch(error => console.error('Error loading rooms:', error));
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  function loadUsers(roomName) {
    fetch(`http://localhost:8080/api/rooms/${roomName}/users`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      }
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to load users');
              return response.json();
            })
            .then(users => {
              const userList = document.getElementById('userList');
              userList.innerHTML = users.map(user => `
                    <div class="p-2 bg-gray-200 rounded">${user}</div>
                `).join('');
              console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —É—á–∞—Å—Ç–Ω–∏–∫–∏:', users);
            })
            .catch(error => console.error('Error loading users:', error));
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ REST
  function loadMessages(roomName) {
    console.log('üîç loadMessages –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã:', roomName);
    fetch(`http://localhost:8080/api/rooms/${roomName}/messages`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      }
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to load messages');
              return response.json();
            })
            .then(messages => {
              document.getElementById('chatMessages').innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
              messages.forEach(msg => showMessage(msg));
              console.log('–ü–æ–ª—É—á–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', messages);
            })
            .catch(error => console.error('Error loading messages:', error));
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
  function createRoom() {
    const roomName = document.getElementById('roomName').value;
    if (!roomName) return;
    fetch('http://localhost:8080/api/rooms', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      },
      body: JSON.stringify({ name: roomName })
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to create room');
              return response.json();
            })
            .then(room => {
              loadRooms(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
              joinRoom(room.name);
              document.getElementById('roomName').value = '';
              console.log('–°–æ–∑–¥–∞–Ω–∞ –∫–æ–º–Ω–∞—Ç–∞:', room);
            })
            .catch(error => console.error('Error creating room:', error));
  }

  // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
  function connectWebSocket(onConnected) {
    if (!accessToken) {
      console.error('‚ùå accessToken –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!');
      return;
    }

    const socket = new SockJS('http://localhost:8080/ws?token=' + accessToken);
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω:', frame);
      if (onConnected) onConnected();
    }, function (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —á–∞—Ç—É');
    });
  }


  // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
  function joinRoom(roomName, isInitialJoin = false) {
    if (currentRoom === roomName && !isInitialJoin) return;

    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç —á–∞—Ç–∞
    if (stompClient && currentRoom && !isInitialJoin) {
      stompClient.unsubscribe('/topic/chat/' + currentRoom);
    }

    currentRoom = roomName;
    document.getElementById('currentRoom').textContent = roomName;
    document.getElementById('chatMessages').innerHTML = '';

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    stompClient.subscribe('/topic/chat/' + roomName, function (message) {
      const msg = JSON.parse(message.body);
      showMessage(msg);
      if (msg.type === 'JOIN') loadUsers(roomName);
    });

    // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –≤—Ö–æ–¥–µ
    stompClient.send('/app/chat.addUser', {}, JSON.stringify({
      sender: username,
      roomId: roomName,
      type: 'JOIN'
    }));

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    loadUsers(roomName);
    loadMessages(roomName);
  }

  // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  function showMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    if (message.type === 'JOIN') {
      messageElement.className = 'text-gray-500 italic';
      messageElement.textContent = `${message.sender} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É`;
    } else {
      messageElement.className = 'p-2';
      messageElement.textContent = `[${message.timestamp}] ${message.sender}: ${message.content}`;
    }
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  document.getElementById('messageForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const messageContent = document.getElementById('messageInput').value.trim();
    if (!messageContent || !stompClient || !stompClient.connected) {
      console.warn('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: stompClient –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω');
      return;
    }

    const chatMessage = {
      sender: username,
      content: messageContent,
      roomId: currentRoom,
      type: 'CHAT'
    };

    stompClient.send('/app/chat.sendMessage', {}, JSON.stringify(chatMessage));
    document.getElementById('messageInput').value = '';
  });
</script>
</body>
</html>