<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чат</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen font-sans">
<div id="authSection" class="w-full max-w-md p-6 bg-white rounded-lg shadow-md mt-4">
  <div class="flex justify-between mb-4">
    <button onclick="showLogin()" class="text-blue-500 font-bold">Вход</button>
    <button onclick="showRegister()" class="text-blue-500 font-bold">Регистрация</button>
  </div>
  <div id="loginFormSection">
    <h2 class="text-2xl font-bold mb-4 text-center">Вход</h2>
    <form id="loginForm" class="space-y-4">
      <input id="loginUsername" type="text" placeholder="Имя пользователя" class="w-full p-2 border rounded" required>
      <input id="loginPassword" type="password" placeholder="Пароль" class="w-full p-2 border rounded" required>
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Войти</button>
    </form>
    <p class="mt-2 text-center text-red-500 hidden" id="loginError">Ошибка входа</p>
  </div>
  <div id="registerFormSection" class="hidden">
    <h2 class="text-2xl font-bold mb-4 text-center">Регистрация</h2>
    <form id="registerForm" class="space-y-4">
      <input id="registerUsername" type="text" placeholder="Имя пользователя" class="w-full p-2 border rounded" required>
      <input id="registerPassword" type="password" placeholder="Пароль" class="w-full p-2 border rounded" required>
      <select id="registerRole" class="w-full p-2 border rounded" required>
        <option value="USER">Пользователь</option>
        <option value="ADMIN">Администратор</option>
      </select>
      <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Зарегистрироваться</button>
    </form>
    <p class="mt-2 text-center text-red-500 hidden" id="registerError">Ошибка регистрации</p>
  </div>
</div>

<div id="chatSection" class="w-full max-w-4xl mt-6 hidden">
  <div class="flex space-x-4">
    <div class="w-1/3 bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-bold mb-4">Комнаты</h2>
      <div id="roomList" class="space-y-2 mb-4"></div>
      <input id="roomName" type="text" placeholder="Название комнаты" class="w-full p-2 border rounded mb-2">
      <button onclick="createRoom()" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Создать комнату</button>
      <h2 class="text-xl font-bold mt-6 mb-4">Участники</h2>
      <div id="userList" class="space-y-2"></div>
    </div>
    <div class="w-2/3 bg-white p-4 rounded-lg shadow-md">
      <h2 class="text-xl font-bold mb-4">Чат: <span id="currentRoom">Public</span></h2>
      <div id="chatMessages" class="h-96 overflow-y-auto border p-2 mb-4"></div>
      <form id="messageForm" class="flex space-x-2">
        <input id="messageInput" type="text" placeholder="Сообщение" class="w-full p-2 border rounded" required>
        <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Отправить</button>
      </form>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  let accessToken = null;
  let username = null;
  let currentRoom = 'Public';

  // Показать форму входа
  function showLogin() {
    document.getElementById('loginFormSection').classList.remove('hidden');
    document.getElementById('registerFormSection').classList.add('hidden');
  }

  // Показать форму регистрации
  function showRegister() {
    document.getElementById('registerFormSection').classList.remove('hidden');
    document.getElementById('loginFormSection').classList.add('hidden');
  }

  // Регистрация
  document.getElementById('registerForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const usernameInput = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const role = document.getElementById('registerRole').value;
    fetch('http://localhost:8080/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: usernameInput, password: password, role: role })
    })
            .then(response => {
              if (!response.ok) throw new Error('Registration failed');
              return response.text();
            })
            .then(data => {
              alert('Регистрация успешна! Пожалуйста, войдите.');
              showLogin();
              document.getElementById('registerUsername').value = '';
              document.getElementById('registerPassword').value = '';
              document.getElementById('registerRole').value = 'USER';
            })
            .catch(error => {
              document.getElementById('registerError').classList.remove('hidden');
              console.error('Registration error:', error);
            });
  });

  // Вход
  document.getElementById('loginForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const usernameInput = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    login(usernameInput, password);
  });

  function login(usernameInput, password) {
    fetch('http://localhost:8080/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: usernameInput, password: password })
    })
            .then(response => {
              if (!response.ok) throw new Error('Login failed');
              return response.json();
            })
            .then(data => {
              accessToken = data.accessToken;
              username = data.username;
              localStorage.setItem('accessToken', accessToken);
              document.getElementById('authSection').classList.add('hidden');
              document.getElementById('chatSection').classList.remove('hidden');
              loadRooms();
              connectWebSocket();
              joinRoom('Public'); // Автоматически присоединяемся к Public при входе
            })
            .catch(error => {
              document.getElementById('loginError').classList.remove('hidden');
              console.error('Login error:', error);
            });
  }

  // Загрузка списка комнат
  function loadRooms() {
    fetch('http://localhost:8080/api/rooms', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      }
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to load rooms');
              return response.json();
            })
            .then(rooms => {
              const roomList = document.getElementById('roomList');
              roomList.innerHTML = rooms.map(room => `
                    <div class="p-2 bg-gray-200 rounded cursor-pointer hover:bg-gray-300"
                         onclick="joinRoom('${room.name}')">${room.name}</div>
                `).join('');
              console.log('Загружены комнаты:', rooms);
            })
            .catch(error => console.error('Error loading rooms:', error));
  }

  // Загрузка списка участников
  function loadUsers(roomName) {
    fetch(`http://localhost:8080/api/rooms/${roomName}/users`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      }
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to load users');
              return response.json();
            })
            .then(users => {
              const userList = document.getElementById('userList');
              userList.innerHTML = users.map(user => `
                    <div class="p-2 bg-gray-200 rounded">${user}</div>
                `).join('');
              console.log('Загружены участники:', users);
            })
            .catch(error => console.error('Error loading users:', error));
  }

  // Загрузка истории сообщений через REST
  function loadMessages(roomName) {
    fetch(`http://localhost:8080/api/rooms/${roomName}/messages`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      }
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to load messages');
              return response.json();
            })
            .then(messages => {
              document.getElementById('chatMessages').innerHTML = ''; // Очищаем перед загрузкой
              messages.forEach(msg => showMessage(msg));
              console.log('Получена история сообщений:', messages);
            })
            .catch(error => console.error('Error loading messages:', error));
  }

  // Создание комнаты
  function createRoom() {
    const roomName = document.getElementById('roomName').value;
    if (!roomName) return;
    fetch('http://localhost:8080/api/rooms', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      },
      body: JSON.stringify({ name: roomName })
    })
            .then(response => {
              if (!response.ok) throw new Error('Failed to create room');
              return response.json();
            })
            .then(room => {
              loadRooms(); // Обновляем список комнат
              joinRoom(room.name);
              document.getElementById('roomName').value = '';
              console.log('Создана комната:', room);
            })
            .catch(error => console.error('Error creating room:', error));
  }

  // Подключение к WebSocket
  function connectWebSocket() {
    const socket = new SockJS('http://localhost:8080/ws?token=' + accessToken);
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      console.log('Connected: ' + frame);
    }, function (error) {
      console.error('WebSocket error:', error);
    });
  }

  // Присоединение к комнате
  function joinRoom(roomName) {
    if (currentRoom === roomName) return; // Избегаем повторного присоединения

    if (stompClient && currentRoom) {
      stompClient.unsubscribe('/topic/chat/' + currentRoom);
      stompClient.unsubscribe('/user/queue/history');
    }

    currentRoom = roomName;
    document.getElementById('currentRoom').textContent = roomName;
    document.getElementById('chatMessages').innerHTML = '';
    loadUsers(roomName);
    loadMessages(roomName); // Загружаем историю через REST

    // Подписка на историю сообщений через WebSocket
    stompClient.subscribe('/user/queue/history', function (message) {
      const history = JSON.parse(message.body);
      console.log('Получена история сообщений через WebSocket:', history);
      history.forEach(msg => showMessage(msg));
    });

    // Подписка на сообщения комнаты
    stompClient.subscribe('/topic/chat/' + roomName, function (message) {
      const msg = JSON.parse(message.body);
      showMessage(msg);
      if (msg.type === 'JOIN') loadUsers(roomName);
    });

    // Отправка сообщения о присоединении
    stompClient.send('/app/chat.addUser', {}, JSON.stringify({
      sender: username,
      roomId: roomName,
      type: 'JOIN'
    }));
  }

  // Отображение сообщения
  function showMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    if (message.type === 'JOIN') {
      messageElement.className = 'text-gray-500 italic';
      messageElement.textContent = `${message.sender} присоединился к чату`;
    } else {
      messageElement.className = 'p-2';
      messageElement.textContent = `[${message.timestamp}] ${message.sender}: ${message.content}`;
    }
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Отправка сообщения
  document.getElementById('messageForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const messageContent = document.getElementById('messageInput').value;
    if (!messageContent) return;
    stompClient.send('/app/chat.sendMessage', {}, JSON.stringify({
      sender: username,
      content: messageContent,
      roomId: currentRoom,
      type: 'CHAT'
    }));
    document.getElementById('messageInput').value = '';
  });
</script>
</body>
</html>