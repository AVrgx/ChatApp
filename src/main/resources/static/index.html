<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Многопользовательский чат</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f6f9;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      gap: 20px;
    }
    .sidebar {
      width: 250px;
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .chat {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #f9f9f9;
      margin-bottom: 10px;
      min-height: 300px;
    }
    .message {
      margin: 8px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .message.own {
      background: #007bff;
      color: white;
      align-self: flex-end;
    }
    .message.other {
      background: #e9ecef;
      color: #333;
      align-self: flex-start;
    }
    .message.join, .message.leave {
      background: #6c757d;
      color: white;
      font-style: italic;
      align-self: center;
      max-width: 80%;
      text-align: center;
    }
    .input-area {
      display: flex;
      gap: 10px;
    }
    input, button, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    input, select { flex: 1; }
    button {
      background: #007bff;
      color: white;
      cursor: pointer;
      border: none;
    }
    button:hover { background: #0056b3; }
    .room-item {
      padding: 10px;
      background: #f1f3f5;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .room-item.active {
      background: #007bff;
      color: white;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Левая панель: комнаты -->
  <div class="sidebar">
    <h3>Комнаты</h3>
    <select id="roomSelect"></select>
    <button id="createRoomBtn">Создать комнату</button>

    <h3>Участники</h3>
    <div id="usersList">—</div>
  </div>

  <!-- Основной чат -->
  <div class="main">
    <div class="chat">
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Введите сообщение..." />
        <button id="sendBtn">Отправить</button>
      </div>
    </div>
  </div>
</div>

<!-- Подключаем библиотеки -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@7.0.0/umd/stomp.min.js"></script>

<script>
  // === Переменные ===
  const token = localStorage.getItem('jwtToken') || '';
  const username = localStorage.getItem('username') || '';

  let stompClient = null;
  let currentRoom = null;

  // === DOM элементы ===
  const messagesEl = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const roomSelect = document.getElementById('roomSelect');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const usersList = document.getElementById('usersList');

  // === Функция: добавить сообщение в чат ===
  function addMessage(msg) {
    const div = document.createElement('div');
    div.className = 'message';

    if (msg.sender === username) {
      div.classList.add('own');
    } else if (msg.type === 'JOIN' || msg.type === 'LEAVE') {
      div.classList.add(msg.type === 'JOIN' ? 'join' : 'leave');
    } else {
      div.classList.add('other');
    }

    div.innerHTML = `
            <strong>${msg.sender}</strong>
            <span style="font-size:0.8em; opacity:0.7">[${msg.timestamp}]</span>
            <br>
            ${msg.content || (msg.type === 'JOIN' ? 'присоединился к чату' : 'покинул чат')}
        `;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // === Подключение к WebSocket ===
  function connect() {
    if (!token) {
      alert('Нет токена! Войдите в систему.');
      return;
    }

    const socket = new SockJS(`http://localhost:8080/ws?token=${token}`);
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
      console.log('WebSocket подключен');

      // Загружаем список комнат
      fetchRooms();

      // Подписываемся на получение сообщений текущей комнаты
      if (currentRoom) {
        subscribeToRoom(currentRoom);
      }

    }, function (error) {
      console.error('Ошибка подключения:', error);
      alert('Не удалось подключиться к чату. Проверь токен и сервер.');
    });
  }

  // === Подписаться на комнату ===
  function subscribeToRoom(roomName) {
    if (stompClient && stompClient.connected) {
      // Отписываемся от предыдущей
      if (currentRoom) {
        stompClient.unsubscribe(`/topic/chat/${currentRoom}`);
      }

      // Подписываемся на новую
      stompClient.subscribe(`/topic/chat/${roomName}`, function (message) {
        const chatMessage = JSON.parse(message.body);
        addMessage(chatMessage);
      });

      // Запрашиваем историю
      stompClient.send("/app/chat.addUser", {}, JSON.stringify({
        sender: username,
        roomId: roomName,
        type: "JOIN"
      }));

      currentRoom = roomName;
    }
  }

  // === Отправить сообщение ===
  sendBtn.onclick = function () {
    const content = messageInput.value.trim();
    if (!content || !currentRoom) return;

    const msg = {
      sender: username,
      content: content,
      roomId: currentRoom,
      type: "CHAT"
    };

    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(msg));
    messageInput.value = '';
  };

  // === Создать комнату ===
  createRoomBtn.onclick = function () {
    const name = prompt('Имя новой комнаты:');
    if (!name) return;

    fetch('http://localhost:8080/api/rooms', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ name })
    })
            .then(res => res.json())
            .then(room => {
              fetchRooms(); // обновляем список
              setTimeout(() => {
                roomSelect.value = room.name;
                joinRoom();
              }, 500);
            })
            .catch(err => alert('Ошибка создания комнаты: ' + err.message));
  };

  // === Получить список комнат ===
  function fetchRooms() {
    fetch('http://localhost:8080/api/rooms')
            .then(res => res.json())
            .then(rooms => {
              roomSelect.innerHTML = '';
              rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.name;
                option.textContent = room.name;
                roomSelect.appendChild(option);
              });

              if (rooms.length > 0 && !currentRoom) {
                roomSelect.value = rooms[0].name;
                joinRoom();
              }
            });
  }

  // === Присоединиться к комнате ===
  roomSelect.onchange = joinRoom;

  function joinRoom() {
    const roomName = roomSelect.value;
    if (roomName && stompClient?.connected) {
      subscribeToRoom(roomName);
    }
  }

  // === Вход в чат (логин) ===
  function login() {
    const user = prompt('Введите имя:');
    const pass = prompt('Введите пароль:');

    if (!user || !pass) return;

    fetch('http://localhost:8080/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: user, password: pass })
    })
            .then(res => res.json())
            .then(data => {
              localStorage.setItem('jwtToken', data.accessToken);
              localStorage.setItem('username', data.username);
              location.reload();
            })
            .catch(() => alert('Ошибка входа'));
  }

  // === Проверка токена и вход ===
  if (!token || !username) {
    login();
  } else {
    connect();
  }

  // === Обработка закрытия вкладки ===
  window.addEventListener('beforeunload', () => {
    if (stompClient && currentRoom) {
      stompClient.send("/app/chat.addUser", {}, JSON.stringify({
        sender: username,
        roomId: currentRoom,
        type: "LEAVE"
      }));
    }
  });

</script>

</body>
</html>